<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense</title>
</head>
<body>
    
    <form onsubmit="Expense(event)">
        <label for="amount">amount:</label>
        <input id="amount" type="text"><br>
        <label for="description">description:</label>
        <input type="text" id="description"><br>
        <label for="category">category:</label>
        
        <select id="category">
        <option value="food">Food</option>
        <option value="petrol">Petrol</option>
        <option value="salary">Salary</option>
        </select>

        <input type="submit" value="Add Expense">
        <p id="message"></p>

        <ul id="List">

        </ul>

        <div id="leaderboard">

        </div>
    </form>

    <button id="rzp-button1">Buy Premium</button>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>

    <script>
      
      const ul = document.getElementById('List');

     async function Expense(e){
      
        e.preventDefault();
        const token = localStorage.getItem('token');
        const amount = e.target[0].value;
        const description = e.target[1].value;
        const category = e.target[2].value;

        const obj = {
            amount: amount,
            description:description,
            category:category
        }

        const Expense = await axios.post("http://localhost:3000/expense/addexpense",obj, { headers: {"Authorization": token}});
        console.log(Expense);
        showUserOnScreen(Expense.data);
 }

 function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}


 window.addEventListener('DOMContentLoaded',async () => {
     const token = localStorage.getItem('token');
     const decodedToken = parseJwt(token);
     console.log(decodedToken);

     const isAdmin = decodedToken.ispremiumuser;

     if(isAdmin){
        document.getElementById('rzp-button1').remove();
            //document.body.innerHTML = document.body.innerHTML+'<p>You are premium user</p>';
            document.getElementById('message').innerHTML += 'You are premium user' ;
            showLeaderboard();
     }

     const Expenses = await axios.get("http://localhost:3000/expense/expense", { headers: {"Authorization": token}});

     for(let i=0; i<Expenses.data.length; i++){
        showUserOnScreen(Expenses.data[i]);
     }
 })

 function showUserOnScreen(realObj){
    
  const li = document.createElement('li');

  const amountChild = document.createTextNode(realObj.amount);
  const descriptionChild = document.createTextNode(realObj.description);
  const categoryChild = document.createTextNode(realObj.category);

  const delet = document.createElement('BUTTON');
  delet.setAttribute('id',realObj.id);
  delet.appendChild(document.createTextNode("DELETE"));

  li.appendChild(amountChild);
  li.appendChild(document.createTextNode("-"));
  li.appendChild(descriptionChild);
  li.appendChild(document.createTextNode("-"));
  li.appendChild(categoryChild);

  li.appendChild(delet);

  li.childNodes[5].addEventListener('click',deleteClick);
     
  ul.appendChild(li);
 }

 async function deleteClick(e){
    
    e.preventDefault();
    const id = e.target.parentNode.childNodes[5].id;

    const token = localStorage.getItem('token');

   try{
    await axios.delete(`http://localhost:3000/expense/deleteExpense/${id}`,{ headers: {"Authorization": token}});
    e.target.parentNode.parentNode.removeChild(e.target.parentNode);
   }
   catch(err){
    console.log(err)
   }
 }
 
 function showLeaderboard(){

    const inputElement = document.createElement('input');
    inputElement.type = "button";
    inputElement.value = "Show Leaderboard";

    inputElement.onclick = async() => {
        const token = localStorage.getItem('token');
       const userLeaderBoardArray = await axios.get("http://localhost:3000/premium/showLeaderBoard", { headers: {"Authorization": token}});

        console.log(userLeaderBoardArray);

        let leaderboardElem = document.getElementById('leaderboard');
        leaderboardElem.innerHTML += '<h1> LeaderBoard </h1>'

        userLeaderBoardArray.data.forEach((userDetails) => {
            leaderboardElem.innerHTML += `<li>Name - ${userDetails.name} Total Expense-${userDetails.total_cost}`
        })

    }

    document.getElementById("message").appendChild(inputElement);
 }






 document.getElementById('rzp-button1').onclick = async function(e) {

    const token = localStorage.getItem('token');
    const response = await axios.get("http://localhost:3000/purchase/premiummembership", { headers: {"Authorization": token}});

    console.log(response);

    var options = 
    {
        
        "key" : response.data.key_id,
        "order_id" : response.data.order.id,
        "handler": async function (res){
            await axios.post("http://localhost:3000/purchase/updatetransactionstatus",{
                order_id: options.order_id,
                payment_id: res.razorpay_payment_id,
            },{headers: {"Authorization" : token}})
            // console.log("second");
            // console.log(res);

            alert("You Are a Premium User")

            document.getElementById('rzp-button1').remove();
            document.getElementById('message').innerHTML += 'You are premium user' ;
            localStorage.setItem('token',res.data.token);
            showLeaderboard();
        },
    };
   
   // console.log("first");
    const rzp1 = new Razorpay(options);
    rzp1.open();

    rzp1.on('payment.failed', async function(response){
        
       const answer =  await axios.post("http://localhost:3000/purchase/updateFailedtransactionstatus",{order_id: options.order_id},{headers: {"Authorization" : token}})

      // console.log(answer);
    });
 }

    </script>

</body>
</html>